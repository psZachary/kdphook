#include "ipc.h"

IPC_COMM_SECRET comm_secret = 0;

int (NTAPI* NtUserCalculatePopupWindowPosition_o)(unsigned long long, unsigned long long, unsigned int, unsigned long long, unsigned long long);
int NTAPI NtUserCalculatePopupWindowPosition_hk(
    unsigned long long a,
    unsigned long long b,
    unsigned int       c,
    unsigned long long d,
    unsigned long long e
) {
    IPC_COMM_SECRET secret = (IPC_COMM_SECRET)c;
    IPC_COMM* comm = (IPC_COMM*)a;

    if (secret == comm_secret) {
        if (!comm) return IPC_COMM_FAILURE;

        if (comm->type == BASIC_REPEAT_SECRET)
            return comm_secret;

        if (comm->type == READ_PROCESS) {
            if (!comm->pid || !comm->addr_from || !comm->addr_to) return IPC_COMM_FAILURE;
            mem_read_process_memory(comm->pid, (PVOID)comm->addr_from, (PVOID)comm->addr_to, comm->size, 0);
        }

        if (comm->type == WRITE_PROCESS) {
            if (!comm->pid || !comm->addr_from || !comm->addr_to) return IPC_COMM_FAILURE;
            mem_write_process_memory(comm->pid, (PVOID)comm->addr_to, (PVOID)comm->addr_from, comm->size, 0);
        }

        return IPC_COMM_SUCCESS;
    }
    
    return NtUserCalculatePopupWindowPosition_o(a, b, c, d, e);
}

NTSTATUS start_ipc(IPC_COMM_SECRET ipc_comm_secret) {
    NTSTATUS status = STATUS_SUCCESS;
    comm_secret = ipc_comm_secret;

    // NtUserCalculatePopupWindowPosition 
    UCHAR pattern[] = "\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\x4C\x8B\x54\x24\x00\x4C\x89\x54\x24\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x00\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x00\xFF\x15\x00\x00\x00\x00\xEB";

    NTSTATUS hook_status = hook_via_data_ptr(
        (PUCHAR)"win32k.sys",
        (PUCHAR)pattern,
        (INT32)sizeof(pattern),
        4,
        (PUCHAR)"winlogon.exe",
        (PVOID)NtUserCalculatePopupWindowPosition_hk,
        (PVOID)&NtUserCalculatePopupWindowPosition_o
    );

    if (hook_status != STATUS_SUCCESS || isbadkptr(NtUserCalculatePopupWindowPosition_o)) {
        printf("hook failed");
        return STATUS_FAIL_CHECK;
    }

    printf("hook started");

    return status;
}